// info.c
// Trigon, 2025

#include "info.h"

#include <sys/sysctl.h>
#include <mach/machine.h>

uint64_t gMappingBase = 0;
mach_port_t gExploitEntry = MACH_PORT_NULL;
DeviceInfo gDeviceInfo = { 0 };

#ifndef CPUFAMILY_ARM_COLL
#define CPUFAMILY_ARM_COLL 0x2876f5b5
#endif

#ifndef CPUFAMILY_ARM_TAHITI
#define CPUFAMILY_ARM_TAHITI 0x75d4acb9
#endif

const char *cpu_family_to_soc_name(cpu_subtype_t cpu_family) {
    switch (cpu_family) {
        case CPUFAMILY_ARM_CYCLONE:
            return "A7";
        case CPUFAMILY_ARM_TYPHOON:
            return "A8";
        case CPUFAMILY_ARM_TWISTER:
            return "A9";
        case CPUFAMILY_ARM_HURRICANE:
            return "A10";
        case CPUFAMILY_ARM_MONSOON_MISTRAL:
            return "A11";
        case CPUFAMILY_ARM_VORTEX_TEMPEST:
            return "A12";
        case CPUFAMILY_ARM_LIGHTNING_THUNDER:
            return "A13";
        case CPUFAMILY_ARM_FIRESTORM_ICESTORM:
            return "A14";
        case CPUFAMILY_ARM_BLIZZARD_AVALANCHE:
            return "A15";
        case CPUFAMILY_ARM_EVEREST_SAWTOOTH:
            return "A16";
        case CPUFAMILY_ARM_COLL:
            return "A17";
        case CPUFAMILY_ARM_TAHITI:
            return "A18";
            
        default:
            return "unknown SoC";
    }
}

void info_init(bool *supported) {
    cpu_subtype_t cpu_family = 0;
    size_t cpu_size = sizeof(cpu_family);
    sysctlbyname("hw.cpufamily", &cpu_family, &cpu_size, 0, 0);
    
    char str[64] = {0};
    size_t size = sizeof(str);
    sysctlbyname("kern.osproductversion", str, &size, 0, 0);
    sscanf(str, "%d.%d.%d", &gDeviceInfo.major, &gDeviceInfo.minor, &gDeviceInfo.patch);
    
    printf("Running on %s, %d.%d.%d\n", cpu_family_to_soc_name(cpu_family), gDeviceInfo.major, gDeviceInfo.minor, gDeviceInfo.patch);
    
    if (gDeviceInfo.major < 13 || gDeviceInfo.major > 15) return;

    switch (cpu_family) {
        case CPUFAMILY_ARM_TWISTER: // A9(X)
            gDeviceInfo.aop = true;
            gDeviceInfo.pageSize = 0x4000;
            *supported = true;
            break;
        case CPUFAMILY_ARM_HURRICANE: // A10(X)
            gDeviceInfo.iorvbar = 0x202050000;
            gDeviceInfo.pageSize = 0x4000;
            *supported = true;
            break;
        case CPUFAMILY_ARM_MONSOON_MISTRAL: // A11
            gDeviceInfo.iorvbar = 0x208050000;
            gDeviceInfo.pageSize = 0x4000;
            *supported = true;
            break;
        default:
            break;
    }
}
